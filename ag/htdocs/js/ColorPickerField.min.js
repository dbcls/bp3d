Ext.ux.ColorPickerField=Ext.extend(Ext.form.TriggerField,{invalidText:"'{0}' is not a valid color - it must be in a the hex format (# followed by 3 or 6 letters/numbers 0-9 A-F)",triggerClass:"x-form-color-trigger",defaultAutoCreate:{tag:"input",type:"text",size:"10",maxlength:"7",autocomplete:"off"},maskRe:/[#a-f0-9]/i,validateValue:function(value){if(!Ext.ux.ColorPickerField.superclass.validateValue.call(this,value)){return false}if(value.length<1){this.setColor("");return true}var parseOK=this.parseColor(value);if(!value||(parseOK==false)){this.markInvalid(String.format(this.invalidText,value));return false}this.setColor(value);return true},setColor:function(color){if(color==""||color==undefined){if(this.emptyText!=""&&this.parseColor(this.emptyText)){color=this.emptyText}else{color="transparent"}}if(this.trigger){this.trigger.setStyle({"background-color":color})}else{this.on("render",function(){this.setColor(color)},this)}},validateBlur:function(){return !this.menu||!this.menu.isVisible()},getValue:function(){return Ext.ux.ColorPickerField.superclass.getValue.call(this)||""},setValue:function(color){Ext.ux.ColorPickerField.superclass.setValue.call(this,this.formatColor(color));this.setColor(this.formatColor(color))},parseColor:function(value){return(!value||(value.substring(0,1)!="#"))?false:(value.length==4||value.length==7)},formatColor:function(value){if(!value||this.parseColor(value)){return value.toUpperCase()}if(value.length==3||value.length==6){return"#"+value.toUpperCase()}return""},menuListeners:{select:function(e,c){this.setValue(c)},show:function(){this.onFocus()},hide:function(){this.focus.defer(10,this)}},onTriggerClick:function(){if(this.disabled){return}if(this.menu==null){var config={closeAction:"hide",modal:true,buttons:[{text:"OK",handler:function(b,e){try{this.menu.fireEvent("select",b,this.menu.getColor(1));this.menu.hide()}catch(e){_dump(e)}},scope:this},{text:"Cancel",handler:function(b,e){try{this.menu.hide()}catch(e){_dump(e)}},scope:this}]};try{var color=this.getValue();if(color.substr(0,1)=="#"){color=color.substr(1)}config.color=color}catch(e){}this.menu=new Ext.ux.ColorDialog(config);this.menu.on(Ext.apply({},this.menuListeners,{scope:this}))}var body_box=Ext.getBody().getBox();body_box.width-=30;var menu_box=this.menu.getBox();var x=this.el.getX();var y=this.el.getY()+this.el.getHeight();if(x+menu_box.width>body_box.width){x=(x+this.el.getWidth()+17)-menu_box.width}if(y+menu_box.height>body_box.height){y=y-this.el.getHeight()-menu_box.height}if(x<0){x=0}if(y<0){y=0}this.menu.setPosition(x,y);try{var color=this.getValue();if(color.substr(0,1)=="#"){color=color.substr(1)}this.menu.setColor(color)}catch(e){}this.menu.show(this.el)}});