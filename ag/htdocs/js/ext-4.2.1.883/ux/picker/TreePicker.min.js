Ext.define("Ext.ux.TreePicker",{extend:"Ext.form.field.Picker",xtype:"treepicker",uses:["Ext.tree.Panel"],triggerCls:Ext.baseCSSPrefix+"form-arrow-trigger",config:{store:null,displayField:null,columns:null,selectOnTab:true,maxPickerHeight:300,minPickerHeight:100},editable:false,initComponent:function(){var me=this;me.callParent(arguments);me.addEvents("select");me.mon(me.store,{scope:me,load:me.onLoad,update:me.onUpdate})},createPicker:function(){var me=this,picker=new Ext.tree.Panel({shrinkWrapDock:2,store:me.store,floating:true,displayField:me.displayField,columns:me.columns,minHeight:me.minPickerHeight,maxHeight:me.maxPickerHeight,manageHeight:false,shadow:false,listeners:{scope:me,itemclick:me.onItemClick},viewConfig:{listeners:{scope:me,render:me.onViewRender}}}),view=picker.getView();if(Ext.isIE9&&Ext.isStrict){view.on({scope:me,highlightitem:me.repaintPickerView,unhighlightitem:me.repaintPickerView,afteritemexpand:me.repaintPickerView,afteritemcollapse:me.repaintPickerView})}return picker},onViewRender:function(view){view.getEl().on("keypress",this.onPickerKeypress,this)},repaintPickerView:function(){var style=this.picker.getView().getEl().dom.style;style.display=style.display},alignPicker:function(){var me=this,picker;if(me.isExpanded){picker=me.getPicker();if(me.matchFieldWidth){picker.setWidth(me.bodyEl.getWidth())}if(picker.isFloating()){me.doAlign()}}},onItemClick:function(view,record,node,rowIndex,e){this.selectItem(record)},onPickerKeypress:function(e,el){var key=e.getKey();if(key===e.ENTER||(key===e.TAB&&this.selectOnTab)){this.selectItem(this.picker.getSelectionModel().getSelection()[0])}},selectItem:function(record){var me=this;me.setValue(record.getId());me.picker.hide();me.inputEl.focus();me.fireEvent("select",me,record)},onExpand:function(){var me=this,picker=me.picker,store=picker.store,value=me.value,node;if(value){node=store.getNodeById(value)}if(!node){node=store.getRootNode()}picker.selectPath(node.getPath());Ext.defer(function(){picker.getView().focus()},1)},setValue:function(value){var me=this,record;me.value=value;if(me.store.loading){return me}record=value?me.store.getNodeById(value):me.store.getRootNode();if(value===undefined){record=me.store.getRootNode();me.value=record.getId()}else{record=me.store.getNodeById(value)}me.setRawValue(record?record.get(me.displayField):"");return me},getSubmitValue:function(){return this.value},getValue:function(){return this.value},onLoad:function(){var value=this.value;if(value){this.setValue(value)}},onUpdate:function(store,rec,type,modifiedFieldNames){var display=this.displayField;if(type==="edit"&&modifiedFieldNames&&Ext.Array.contains(modifiedFieldNames,display)&&this.value===rec.getId()){this.setRawValue(rec.get(display))}}});